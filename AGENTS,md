# 智能聊天客服 Agent 说明

## 1. 概览
这是一个面向终端用户的智能聊天客服 Agent，结合大语言模型与 RAG（Retrieval-Augmented Generation）能力，实现两大核心功能：
1. **短期记忆上下文管理**：基于 userid 保持最近 30 轮的对话历史，用作生成上下文和澄清/进阶行为参考。
2. **知识增强响应（RAG + 标准话术）**：动态检索产品内容与预设话术，在触发规则成立时将其注入生成流程或直接输出标准话术。

该 Agent 以结构化输入/输出契约驱动，便于前端、业务规则层与 LLM 调用解耦和测试。

---

## 2. Architecture / 组件职责

### 2.1 会话管理 Agent
- 维护每个 `userid` 的短期记忆队列（最近 30 轮，user/assistant 交替）。
- 支持超出长度时的摘要压缩（可选）。
- 提取与缓存关键实体（如订单号、意图标签、产品名称）。

### 2.2 检索增强 Agent（RAG）
- 把用户当前输入和必要上下文 embedding 后去向量数据库检索相关内容：
  - 产品文档（FAQ、说明、政策等）。
  - 预定义标准话术模板（带元数据：类别、版本、触发意图）。
- 评估相似度并应用触发规则决定是否“增强”或“用标准话术”。

### 2.3 生成/响应 Agent（LLM Prompting）
- 组合：短期记忆摘要 + 原始用户消息 + 检索到的增强片段 + 指令模板。
- 调用大语言模型生成结构化回复（含主回答、下一步建议、触发来源标签等）。
- 处理不确定/模糊情况时生成澄清问题。

---

## 3. 输入 / 输出格式

### 输入（前端到 Agent）
```json
{
  "userid": "user_12345",
  "message": "我想退货，为什么订单还没到？",
  "metadata": {
    "channel": "web_chat",
    "timestamp": "2025-08-01T14:23:00Z",
    "session_id": "session_xyz"
  }
}
````

### 输出（Agent 返回前端）

```json
{
  "userid": "user_12345",
  "response": "很抱歉，您的订单正在运输中，预计两天内送达。如果需要退货，我可以帮您生成退货申请。请问订单号是多少？",
  "source_info": {
    "used_memory_context": [...],         // 摘要或引用的历史对话
    "matched_documents": [
      {
        "id": "faq_return_policy",
        "title": "退货政策",
        "similarity_score": 0.87
      }
    ],
    "triggered_script": "return_flow_v2",
    "confidence": 0.92
  },
  "timestamp": "2025-08-01T14:23:01Z"
}
```

---

## 4. 记忆策略（Short-Term Memory）

### 结构

每轮记录格式：

```json
{
  "role": "user" | "assistant",
  "text": "...",
  "timestamp": "..."
}
```

### 策略

* **保留窗口**：默认保留最近 30 轮完整对话。
* **摘要压缩**：当超过阈值时，可将最早若干轮通过 LLM 生成一句浓缩摘要（例：“此前用户关注退货流程与物流延迟”），替代原始多条以节省 token。
* **实体/意图抽取**：并行提取（例如订单号、产品名、核心诉求）用于快速规则匹配与检索提示增强。

---

## 5. RAG 与话术触发规则

### 数据源片段类型

* `faq`：常见问题/政策说明
* `product_doc`：产品说明、运输时间、售后流程
* `script`：标准客服话术模板（带版本，例如 `return_flow_v2`）

每段对应向量 embedding，附带元数据字段：`category`, `version`, `tags`, `created_at`

### 检索流程

1. 把用户最新消息（加上必要上下文摘要）做 embedding。
2. 搜索向量库 top-K 相关片段（默认 K=5\~10）。
3. 依据相似度与规则引擎判断是否：

   * **触发标准话术**（优先用模板输出）
   * **增强 Prompt**（把片段注入到 LLM 输入）
4. 典型触发条件例子：

   * 意图被判定为 “退货” 且匹配到的 script 相似度 ≥ 0.8
   * 同时包含关键词组合（如“订单”、“没到”+“退货”）
   * FAQ 中有关“物流延迟”且用户表达焦虑语气（通过情绪/槽位辅助）

---

## 6. Prompt 结构模板（给 LLM）

```text
上下文：
{近期会话摘要或最后几轮对话}

检索增强内容：
- {话术模板: return_flow_v2 (退货流程)}
- {FAQ: 订单运输时间说明}

用户当前意图：{退货/物流查询/投诉等}
指令：
1. 优先使用匹配到的标准话术回答（如果触发）。
2. 以礼貌、明确的方式告知用户当前状态。
3. 如果缺关键数据（如订单号），用简短问题澄清。
4. 提供下一步建议或行动项。

输出结构（必须包含）：
- 主回答（自然语言）
- 推荐的下一步（如果需要用户操作）
- 触发来源（如：faq_return_policy, script_return_flow_v2）
- 置信度估计（可选）
```

---

## 7. 典型对话示例

### 场景：用户要退货且问物流

**输入**：
`"我想退货，为什么订单还没到？"`

**处理**：

* 识别意图：退货 + 物流状态查询
* 检索到 FAQ（运输延迟说明）和 Script（退货话术模板 v2）
* 构造 Prompt 用话术 + 上下文生成回复

**输出**（示例）：

> “很抱歉，您的订单正在运输中，预计两天内送达。如果您确认要退货，我可以先帮您生成退货申请。请提供订单号。”
> 附带触发来源：`return_flow_v2`，matched FAQ: `shipping_delay_info`

---

## 8. 配置（示例 YAML 片段）

```yaml
memory:
  max_rounds: 30
  summary_threshold: 30
  enable_entity_extraction: true

retrieval:
  embedding_model: "text-embedding-ada-002"
  top_k: 5
  similarity_trigger: 0.8

scripts:
  - id: return_flow_v2
    trigger_intents: ["退货", "退款"]
    min_similarity: 0.8
    template_location: "scripts/return_flow_v2.md"
    version: "2025-07-15"

prompting:
  default_response_style: "friendly_structured"
  clarification_phrases:
    - "请问订单号是多少？"
    - "您是想退货还是查询物流状态？"
```

---

## 9. 评估与监控指标

* **话术触发准确率**：应该被触发的场景中实际触发比例。
* **上下文保持率**：用户不用重复信息的多轮比例。
* **意图识别精度/召回**
* **澄清率**：因缺少关键信息而发起澄清的频次（过高表示提取或 prompt 问得不清）。
* **平均响应时延**
* **用户满意度 proxy**（如后续用户继续交互、无再问率）

---

## 10. 降级 & 回退逻辑

* **检索无结果**：仅用上下文 + 基础模板生成回答（不假定事实）。
* **意图模糊**：生成澄清句（如“您是想退货还是查询订单状态？”）。
* **LLM 输出异常**：检测到语义混乱/敏感词后切换到安全 fallback 回复，并标记人工复核。
* **标准话术版本失效**：回退到上一稳定版本（基于 `triggered_script.version` 追踪）。

---

## 11. 安全与合规

* `userid` 必须绑定可信 session token，防止伪造。
* 所有对话日志在存储前进行 PII 脱敏/哈希（如银行卡、完整身份证号）。
* 话术模板带版本与审核标记，未经审核不可直接用于用户。
* 限流与防刷（防止单一用户触发大量模型调用）。
* 审计字段嵌入每次响应（request\_id, model\_version, script\_version, timestamp）。

---

## 12. 拓展方向

* **长期用户画像记忆**（偏好、历史问题类别、满意度反馈）。
* **A/B 话术实验平台**（版本权重动态调整）。
* **多模态融合**（用户上传图片 + 文本意图联合判别）。
* **预测性客服**（基于用户行为提前提示潜在问题）。
* **多语种/本地化话术管理**。

---

## 13. 常见问题

**Q：什么时候直接用标准话术？**
A：当意图匹配 + 检索相似度 ≥ 配置阈值，且话术未过期且已审核。

**Q：短期记忆超过 30 轮怎么办？**
A：早期轮次自动摘要压缩，保留关键意图与实体。

**Q：如何回退某个话术版本？**
A：每次响应携带 `script_version`，系统检测到上线后效果下降可在配置中指定回退到历史版本。
